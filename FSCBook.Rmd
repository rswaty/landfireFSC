--- 
title: "Using LANDFIRE Products to explore historical and current ecosystems"
author: "Draft by The Nature Conservancy's LANDFIRE team"
date: "`r Sys.Date()`"
site: bookdown::bookdown_site
documentclass: book



---

# Introduction
The [Forest Stewardship Council](https://fsc.org/en) develops and delivers Principles, Criteria and Indicators for sustainable forest management (need link to correct standard).   Principles 6 and 9  are focused on Environmental Impact and Maintenance of High Conservation Value Areas respectfully.  Many of the criteria and indicators within those principles require a GIS assessment of historical and current vegetation conditions, disturbance regimes and landscape patterns

[LANDFIRE](https://landfire.gov/) is an interagency program within the United States that "provides 20+ national geo-spatial layers (e.g. vegetation, fuel, disturbance, etc.), databases, and ecological models that are available to the public for the US and insular areas."  With this data it is possible to fulfill the requirements of several indicators within Principles 6 and 9.  Here we provide guidance for:

* downloading relevant LANDFIRE datasets and models
* completing the GIS processing of LANDFIRE data
* developing visuals (e.g., maps and charts) to help illustrate findings


In general the analyses developed here will help managers:

* quantify ecosystems past and present
* explore ecosystem conversion (both to unnatural (e.g., urban) land uses and different ecosystems)
* compare amounts of succession classes past and present
* document types and amounts of historical disturbances


In the United States, including the insular areas, [LANDFIRE](https://www.landfire.gov/) provides the datasets and ecological model results to get at these challenges and more.  Here we walk you through some of the technical steps needed to start your analysis.  We will do our work in a model landscape, the Michigamme Highlands in the Upper Peninsula of Michigan (highlighted in green in map below).

To help you with the concepts we work through pre-processed LANDFIRE data for an example landscape.  To prepare the datasets for your landscape see the Appendix.


**ZOOM, pan, explore the Michigamme Highlands area**
```{r loadshp, message=FALSE, warning=FALSE, include=FALSE}
library(raster)
library(leaflet)
library(sf)

michi <- st_read("michishp.shp")
michi <- st_transform(michi, CRS("+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0"))

```


```{r leafletMichi, echo=FALSE, message=FALSE, warning=FALSE}

leaflet(data = michi) %>% 
  addTiles() %>% 
  addPolygons(fill = FALSE, stroke = TRUE, color = "#193b22")

```

```{r echo=FALSE, message=FALSE, warning=FALSE}

### EXAMPLE
knitr::include_graphics("images/combine.JPG")

```

## Download this!
To work through this guide you will need to download this [zipped folder](https://github.com/rswaty/landfireFSC/blob/main/toDownload.zip) by clicking the hyperlinked text, then the "Download" button that will be on the right side of the screen.  This folder contains:

* An Excel file
* One ecosystem description
* An ArcMap map package file in case you want to explore in ArcMap.

## About this document

It was written in R using [R-Studio](https://rstudio.com/), the ["bookdown" package](https://www.bookdown.org/) and is hosted on [GitHub(links to this repository)](https://github.com/rswaty/landfireFSC).  











<!--chapter:end:index.Rmd-->

# Our example landscape {#exampleIntro}

**The Michigamme Highlands**

Our example landscape is in the north central region of the Upper Peninsula of Michigan (a mouthful, eh?).  The largest nearby city is Marquette, MI, population 20,822 (2019).  This ecoregion is ~757,000 acres (306380 hectares) and is know for its beautiful forests, rivers and lakes.  It is underlain by sandstone, slate, shale and iron formations.  Elevations range from around 600ft to almost 2,000 ft above sea level.  The ecoregion  has a humid continental climate with a growing season ranging from 75-150 days and average annual snowfall amounts reaching 200 inches in the higher terrain.

Logging and mining have been the major industrial forces in the area.  Both continue today, especially logging.  Mining has transitioned from largely iron to primarily nickel.  

The area is of conservation interest due to the relatively high connectivity, large average land parcel size and projected climate change resiliency (see map below).




```{r michiResilient, echo=FALSE, out.width= "100%"}
knitr::include_graphics("michilResilience.JPG")

```

<!--chapter:end:01-exampleIntro.Rmd-->

# LANDFIRE Data for landscape assessment {#inputData}

## LANDFIRE for landscape ecosystem assessment

There are some basic steps in assessing the ecological situation of your landscape, including:

* mapping historical and current ecosystems, and the difference between the two; and further looking at representation  of ecosystems inside and outside of your landscape of interest.
* assessing succession classes (aka seral states) of these ecosystems, past and present

These steps, while foundational and conceptually simple, can be difficult due to a lack of data, especially when doing them at a landscape scale which often means looking across multiple land ownerships.  


## The LANDFIRE datasets we used for this guide

* Spatial datasets, clipped to your area(s) of interest
    * [Biophysical Settings (BpS)](https://www.landfire.gov/bps.php).  This dataset will be used to get at "community habitat", or where ecosystems could occur based on abiotic factors (e.g., soils, climate and natural disturbance regimes).
    * [Succession classes](https://www.landfire.gov/sclass.php) characterize structural classes on the landscape at the time the dataset represents (e.g., 2016 for LF Version 200).
    * [Existing Vegetation Type](https://www.landfire.gov/evt.php) maps NatureServe's Ecological Systems (see descriptions [here](https://www.landfire.gov/documents/LANDFIRE_Ecological_Systems_Descriptions_CONUS.pdf)).
* Non-spatial products
    * [Biophysical Settings Descriptions](http://landfirereview.org/test/search.php) which has information on natural disturbance regimes and succession class descriptions (also available [here](https://www.landfire.gov/zip/LANDFIRE_CONUS_SClass_Mapping_Rules_9182020.zip)).  
    * [Reference Condition Table](https://www.landfire.gov/zip/LANDFIRE_CONUS_Reference_Condition_Table_August_2020.zip) supplements the BpS descriptions with the "reference" percentages for each succession class, for each Biophysical Settings.
    
## Guidance on obtaining LANDFIRE products

There are multiple ways to get LANDFIRE products depending on whether you are looking to obtain BpS models and descriptions or the spatial data:

* For BpS models and descriptions go to: http://landfirereview.org/search.php.  Start by clicking on the "View map of LANDFIRE Map Zones".  This will help you narrow down your search.  Alternatively, you can wait to download BpS descriptions until you do some GIS work and get specific names of BpSs of interest.
* For the spatial datasets you can explore options [here](https://www.landfire.gov/getdata.php) which include:
    * Downloading [Full Extent Mosaics](https://www.landfire.gov/version_comparison.php).  When you do use this option you get large files that cover the entire lower 48, AK or HI (depending on your selection).  We use this method when we have several landscapes and/or a large area and no computer storage issues.
    * Using the [LANDFIRE Data Distribution Site](https://www.landfire.gov/viewer/).  With this method you essentially select the datasets you need then draw a rectangle (or you can select state or counties) around your area of interest to start the downloader.  We recommend this if your area of interest is not too large and/or you have a low number of landscapes and/or have storage limits.

<!--chapter:end:03-inputData.Rmd-->

# Historical Ecosystems {#historicalEcosystems}

In this chapter we will learn which ecosystems, and how much of each were on our landscape historically.


## General methods

In this section (and most others) we will depend on "Pivot Tables" in Excel.  They are powerful (for better or worse!) tools that allow for tasks such as:

* organization and formatting of data
* calculations
* filtering data
* nesting data

With the power comes the call for caution.  It is super easy to display values that look illuminating-but may be wrong.  You can easily be duped into complacency, especially when working in the "value field settings."

### A few potential traps with Pivot Tables
Pivot Tables allow you to calculate, summarize, format and analyze datasets.  There are a few traps we run into frequently that are worth mentioning here:

* **Your Pivot Table controls go away**.  This happens when you click outside of the main Pivot Table area (where your values are, usually on the left side of screen).  To fix this click inside one of the Pivot Table columns.  Another way to fix this is to right click inside a Pivot Table cell and select "Show field list". 
* **Miscalculating.**  This typically happens when you are in the "Value Field Settings" pane and select the wrong "Show values as" option.  The key here is to visually inspect the results to make sure you have made the correct selection.
* **You want to remove totals and subtotals without having to delete them all.** To fix this and many formatting issues click anywhere inside of the Pivot Table -> Click "Design" from the top ribbon -> click the "Subtotals" drop down -> click "Do Not Show Subtotals".  Repeat for Grand Totals.  While you are there, explore the Report Layout and Blank Rows drop downs.


## Getting at amounts of historical ecosystems

**Start by opening the "historical" tab in the Excel workbook.**  

1. In the Pivot Table Fields pane, select "BPS_NAME" then "ACRES".  
2. Right click in the top cell of the "Sum of ACRES" column (not the column header) in the Pivot Table, then "Sort Largest to Smallest".
3. In our example we have some BpSs that have low ACRES values.  We also have categories that are not meaningful, such as "Barren-Rock/Sand/Clay".  We can do a little formatting/cleaning before making a chart:
    * To remove BpSs from the table you will click the drop-down menu to the right of "BPS_NAME" in the Pivot Table Fields pane.  You can uncheck BpSs as appropriate.
    * It is also possible to filter by right clicking on the top value in the list of BpSs, then selecting Filter > Top 10....  Once in that menu you can refine the filtering.
4. To get percentages, drag "ACRES" from the top Pivot Table Field pane to the "Values" pane.  This will add a second "ACRES" column to the table.  Click the drop down in the second instance of "ACRES" (reads "SUM of ACRES2" in our example), then Value Field Settings.  In this menu select the "Show Values As" tab, click the "Show Values As" drop down then select "% of Grand Total% to get percentages of each BpS (make sure that "BPS_NAME" is selected as the "Base field").  
5.  To get a "running total" of percentages you will add a third instance of "ACRES" to the "Values" pane, then Value Field Settings.  In this menu select the "Show Values As" tab, click the "Show Values As" drop down then select "% Running Total In" to get running totals of  percentages of each BpS (make sure that "BPS_NAME" is selected as the "Base field"). 
6. Save!



**Example output**

Below is essentially the output from our Pivot Table work with a couple changes:

* Names have been shortened for ease of reading
* Numbers have been rounded

```{r bpsDT, echo=FALSE, message=FALSE, warning=FALSE}
library(DT)
library(readr)
bps <- read_csv("bps.csv")


datatable(head(bps), 
          class = 'cell-border stripe', 
          options = list(scrollX  = TRUE, pageLength = 3)) %>%
  formatRound(c("ACRES", "PERCENT", "RUNNING_PERCENT"), 0)

```

<br>
<br>

We see that the top 4 BpSs comprised ~80% of our example landscape historically.  We can visually confirm this and other patterns with a quick chart made in R (similar charts available in Excel by highlighting the data, clicking Insert then selecting the chart type in the "Charts" tab):

<br>

```{r bpsChart, echo=FALSE, message=FALSE, warning=FALSE}
library(ggplot2)
library(scales)

ggplot(bps, aes(x = reorder(BpS, ACRES), y = ACRES)) + 
  geom_bar(stat = "identity", fill = "grey31") +
  coord_flip() +
  labs(x = "", 
       y = "Acres", 
       title = "Historical Ecosystems of the Michigamme Highlands landscape",
       caption = "From LANDFIRE Biophysical Settings data. Names shortened for clarity.",
       colour = "black") +
  scale_y_continuous(labels = comma) +
theme(plot.title = element_text(size = 15), axis.title = element_text(size = 13), panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(), axis.line = element_line(colour = "black")) +
    theme(plot.caption = element_text(hjust = 0, face= "italic"), #Default is hjust=1
        plot.title.position = "plot", #NEW parameter. Apply for subtitle too.
        plot.caption.position =  "plot")
```



<!--chapter:end:04-historicalEcosystems.Rmd-->

# Existing Vegetation Types {#evt}

While looking at the historical ecosystems gives context, we also need to get a picture of which ecosystems are on the landscape today.  



## General methods

We use the same general methods as we did on the "Historical Ecosystems" page, using a Pivot Table.  We rely on [LANDFIRE's Existing Vegetation Type (EVT)](https://www.landfire.gov/evt.php) data for this assessment.


## Getting at amounts of current ecosystems

**Start by opening the "current" tab in the Excel workbook.**

1. In the Pivot Table Fields pane, select "EVT_NAME" then "ACRES".  Make sure that EVT_NAME is in the "Rows" pane, and that "Sum of ACRES" is in the "Values" pane.  
2. Right click in the top cell of the "Sum of ACRES" column (not the column header) in the Pivot Table, then "Sort Largest to Smallest".
3. In our example we have some BpSs that have low ACRES values.  We also have categories that are not meaningful, such as "Barren-Rock/Sand/Clay".  We can do a little formatting/cleaning before making a chart:
    * To remove EVTs from the table you will click the drop-down menu to the right of "BPS_NAME" in the Pivot Table Fields pane.  You can uncheck BpSs as appropriate.
    * It is also possible to filter by right clicking on the top value in the list of EVTs within the Pivot Table, then selecting Filter > Top 10....  Once in that menu you can refine the filtering.
    * Additionally we like to add commas and remove decimal places.  To do this right click the row that contains "Sum of ACRES" in the spreadsheet (likely row "B"), select "Format Cells" > Number > set Decimal places to "0" then check the "Use 1000 Separator box.
4. To get percentages, drag "ACRES" from the top Pivot Table Field pane to the "Values" pane.  This will add a second "ACRES" column to the table.  Click the drop down in the second instance of "ACRES" (reads "SUM of ACRES2" in our example), then Value Field Settings.  In this menu select the "Show Values As" tab, click the "Show Values As" drop down then select "% of Grand Total% to get percentages of each BpS (make sure that "BPS_NAME" is selected as the "Base field").  
5.  To get a "running total" of percentages you will add a third instance of "ACRES" to the "Values" pane, then Value Field Settings.  In this menu select the "Show Values As" tab, click the "Show Values As" drop down then select "% Running Total In" to get running totals of  percentages of each BpS (make sure that "BPS_NAME" is selected as the "Base field"). 
6. Save!




**Example output**

Below is essentially the output from our Pivot Table work with a couple changes:

* Names have been shortened for ease of reading
* Numbers have been rounded

```{r evtDT, echo=FALSE, message=FALSE, warning=FALSE}
library(DT)
library(readr)
evt <- read_csv("evt.csv")


datatable(head(evt), 
          class = 'cell-border stripe',
          options = list(scrollX  = TRUE, pageLength = 3))%>%
  formatRound(c("ACRES", "PERCENT", "RUNNING PERCENT"), 0)
```

<br>
<br>

We see that first there are many EVT's.  This partially due to the addition of Developed and other "modern" categories such as "Recently Logged-Tree Cover". Second we see that of the "natural" types their is a close match with the historical.  We can visually confirm this and other patterns with a quick chart made in R (similar charts available in Excel by highlighting the data, clicking Insert then selecting the chart type in the "Charts" tab):

<br>

```{r evtChart, echo=FALSE, message=FALSE, warning=FALSE}
library(ggplot2)
library(scales)
library(dplyr)

evt %>%
  top_n(10, ACRES) %>%
ggplot() +
  aes(x = reorder(EVT, ACRES), y = ACRES) + 
  geom_bar(stat = "identity", fill = "grey31") +
  coord_flip() +
  labs(x = "", 
       y = "Acres", 
       title = "Current Ecosystems of the Michigamme Highlands",
       caption = "From LANDFIRE Existing Vegetation Type data. Names shortened for clarity",
       colour = "black") +
  scale_y_continuous(labels = comma) +
theme(plot.title = element_text(size = 15), axis.title = element_text(size = 13), panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(), axis.line = element_line(colour = "black")) +
    theme(plot.caption = element_text(hjust = 0, face= "italic"), #Default is hjust=1
        plot.title.position = "plot", #NEW parameter. Apply for subtitle too.
        plot.caption.position =  "plot")
```



<!--chapter:end:05-evt.Rmd-->

# Exploring conversion {#conversion}

**The main question we explore on this page: how much of the historic ecosystems have been converted to a different land use (e.g., agriculture).**  

## The fine print
While this assessment is illustrative, it is important to note that the methods used to create the BpS and EVT datasets are substantially different, and LANDFIRE datasets are not made for assessing small areas.  Please review.  In the exercise we will focus on the coarsest classifications.  If you need to work at the finer classification levels proceed with caution!

## Pivot table work
Working in the "Conversion" worksheet:

1. Check the "GROUPVEG" then the "EVT_PHYS" fields to add them to the Pivot Table.  Make sure that GROUPVEG is the leftmost column.  If not drag that field to the top in the Rows pane.
2. In the cell above the "GROUPVEG" field header type "past"; in the cell above the "EVT_PHYS" type "present".
3. If you fancy click the dropdown in the "GROUPVEG" header.  Here you can remove types.  Let's remove "Barren-Rock/Sand/Clay".
4. Check the "ACRES" field to add it to the Pivot Table.
5. Explore.  Of what was historically mapped as CONIFER, what's the biggest non-CONIFER type today?
6. Switch the order of the fields by dragging "EVT_PHYS" to the top of the Rows pane.  Which GROUPVEG type was most converted to "Developed"?


## Visual exploration for fun. 

Sometimes patterns emerge from visuals.  Below is a [Sankey Diagram](https://en.wikipedia.org/wiki/Sankey_diagram) generated in R (can also be created in Excel we hear.  See instructions [here](https://mychartguide.com/how-to-draw-sankey-diagram-in-excel/)).  On the left are the historical ecosystems, on the right current ecosystems and flow bands.  The width of the bands is proportional to the flow rate.  Some potential interpretations, partially based on the chart, partially based on local knowledge:

* There is more northern hardwoods mapped today than historically.  This could be due to "simplification" of ecosystems that have some shared species.  For example, many conifers have been removed and deer present a challenge for regeneration.  One hypothesis would be that due to logging and deer the "Pine-Hemlock-Hardwood-Forest" has been essentially converted to "Northern Hardwoods".
* It might be more illuminating to group some types together, such as the "Recently Logged" types.
* LANDFIRE has mapped potential change of the wetlands to other types.  This could be due to mapping errors, or due to alterations in hydrology because of roads perhaps.  More investigation is warranted.

Click [here](https://rswaty.github.io/landfireFSC/sankey.html) to view diagram in your web browser. 

```{r sankey, echo=FALSE, message=FALSE, warning=FALSE, fig.width=10, fig.height=8}

library(networkD3)
library(dplyr)
library(readr)
library(dplyr)

data <- read_csv("bps2evt.csv")

nodes <- data.frame(
  name=c(as.character(data$source), 
         as.character(data$target)) %>% unique())


data$IDsource <- match(data$source, nodes$name)-1 
data$IDtarget <- match(data$target, nodes$name)-1

# Make the Network
snky2 <- sankeyNetwork(Links = data, 
                       Nodes = nodes,
                       Source = "IDsource", 
                       Target = "IDtarget",
                       Value = "value", 
                       NodeID = "name", 
                       fontSize=14,
                       iterations = 0,
                       sinksRight=FALSE)

snky2

# save the widget
library(htmlwidgets)
saveWidget(snky2, "sankey.html")


```


<!--chapter:end:06-conversion.Rmd-->

# Succession Classes {#successionClasses}

## What we will do here
While looking at conversion of historical ecosystems is valuable, we can dig deeper, comparing amounts historical succession classes to current.  This gives us a broad measure of the changes in vegetation structure for ecosystems.

## What are "Succession Classes?"

In general LANDFIRE succession classes are stages of development defined in the descriptions of each Biophysical Setting.  They are characterized by vegetation height, canopy cover and to some degree species composition.  Key takeaways:

* To learn what the succession classes are for each Biophysical Setting you look to the corresponding description on http://landfirereview.org/test/search.php
* LANDFIRE used state and transition models to estimate the amount of each succession class that would occur with natural (pre-European colonization) disturbance regimes.  Historical succession classes were not mapped as they were assumed to move around over time.
* The [Succession Class](https://www.landfire.gov/sclass.php) dataset maps the current location of succession classes, in addition to agricultural and developed land-use classes plus uncharacteristic vegetation.  Uncharacteristic typically represents exotic vegetation, or vegetation structure that would not have occured historically.
* By comparing the amounts of historical and current succession classes you can get a sense of which classes are over/under represented.  This assumes that the landscape you are assessing is large enough to potentially include the full compliment of succession classes.

## Our sample ecosystem

To illustrate the concept of comparing reference to current succession classes we will focus on the Laurentian-Acadian Northern Hardwoods-Hemlock Biophysical Setting.  It is a dominant ecosystem in the Michigamme Highlands, has been heavily managed and faces many threats such as deer browsing.  

## Your tasks
We will start with our friend the Pivot Table to get current percentages of the relevant succession classes, then we will look to the Biophysical Settings descriptions to get historical percentages.

### Current succession classes

1. Open the "successionClasses" worksheet in our "combineClean.xlsx" workbook.
2. In the Pivot Table Fields box highlight "BPS_MODEL" -> click the down arrow -> select only "Laurentian-Acadian Northern Hardwoods Forest - Hemlock".  Check the box next to "BPS_NAME".
3. In the Pivot Table Fields check the box next to "LABEL" to get a list of current succession classes.
4. In the Pivot Table Fields check the box next to "ACRES".
5. In the Values pane click the doww arrow -> select Value Field Settings.  Once the Value field settings are open click Show Values As -> select "% of Grand Total" from the dropdown list.
6. Copy the resultant table -> paste next to the Pivot Table in the same worksheet -> add column names "Succession class" and "Current". 

###  Historical succession classes

1. Open the "NorthernHardwoodsHemlock.docx" document that is in the "toDownload" zipped folder.  
2. Skim through the document to get a sense of the ecosystem, paying particular attention to the "Succession Classes" section.
3. There are be 5 succession classes, A, B, C, D and E with corresponding estimated reference amounts.  For example, Succession Class A was modeled to be rare in this ecosystem that did not have much fire.  LANDFIRE estimated that only 1% of this ecosystem would have been Succession Class a historically.
4. Back in the pivot table, you will create a new column named "Historical", then type the succession class percentages from the document into the corresponding row.  

Now we can start to see some patterns emerge.  We won't spoil your fun by saying what those patterns are!






<!--chapter:end:07-successionClasses.Rmd-->

# APPENDIX {#gisPrep}

## GIS Prep: Combine data

Once spatial data is properly projected and clipped to area of interest, perform a "combine" in ArcMap (Toolbox > Spatial Analyst > Local > Combine) of the BpS, SCL and EVT datasets.  Alternatively, you can combine a raster of the area of interest with those 3 datasets which are stored as larger extents (like shown below).


```{r, echo=FALSE, out.width='100%'} 
knitr::include_graphics("combine.JPG")

```

<br>
<br>

## GIS Prep: Join in attributes

There are multiple ways-we recommend using the Join Field tool (Toolbox > data management tools > joins > add join).  One reason to do this is to be able to select which fields to join in.  A potential resulting table looks like this for a landscape in Michigan (with minimal cleaning/formatting):

<br>
<br>

```{r combineDT, echo=FALSE, message=FALSE, warning=FALSE}
library(DT)
library(readr)
combine <- read_csv("combine.csv")


datatable(head(combine), 
          class = 'cell-border stripe',
          options = list(scrollX  = TRUE, pageLength = 3))
```

<br>
<br>

As is this table does not mean too much-we will need to do some cleaning, formatting and calculating.

## GIS Prep:Clean data table

You will first need to save the combined ".csv" file file as an ".xlsx" file so that you can have multiple worksheets.  We recommend keeping the original output as a "raw" spreadsheet in Excel, pasting that data into a new sheet and working with that new sheet moving forward.
    * It is OK to remove the "US_200BPS", "US_200EVT", and "US_200SCLASS" columns
    * Rename some columns: "GROUPVEG" to "BPSGROUPVEG"; "EVT_PHYS" to "EVTGROUPVEG"; "LABEL" to "SUCCESSIONCLASS", or similar as needed for clarity
    * COUNT = number of 30m x 30m pixels for that combination of BpS-EVT-SCLS.  Insert a column named "ACRES", then calculate acres by multiplying COUNT by "0.222".  Copy-Paste Values for that new column. Below is an example of what our new data table looks like.
    
<br>
<br>

```{r combineCleanDT, echo=FALSE, message=FALSE, warning=FALSE}
library(DT)
library(readr)
combineClean <- read_csv("combineClean.csv")


datatable(head(combine), 
          class = 'cell-border stripe',
          options = list(scrollX  = TRUE, pageLength = 3))
```

<br>
<br>


<!--chapter:end:gisPrep.Rmd-->

